<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat M√©dico</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            transition: background-color 0.3s;
        }

        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        .chat-container {
            max-width: 1000px;
            margin: 20px auto;
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 80vh;
            margin-top: 80px;
        }

        .chat-container.dark-mode {
            background-color: #1e1e1e;
        }

        .contacts-list {
            width: 300px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
        }

        .chat-header.dark-mode {
            background-color: #2d2d2d;
            color: white;
        }

        .messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin: 8px;
            padding: 12px;
            border-radius: 15px;
            position: relative;
        }

        .message.sent {
            background-color: #dcf8c6;
            align-self: flex-end;
        }

        .message.received {
            background-color: #fff;
            align-self: flex-start;
        }

        .message.dark-mode.sent {
            background-color: #056162;
            color: white;
        }

        .message.dark-mode.received {
            background-color: #2d2d2d;
            color: white;
        }

        .message-time {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }

        .chat-input input.dark-mode {
            background-color: #2d2d2d;
            color: white;
            border-color: #555;
        }

        .send-button {
            padding: 10px 20px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .send-button:hover {
            background-color: #00695c;
        }

        .contact {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .contact:hover {
            background-color: #f5f5f5;
        }

        .contact.dark-mode:hover {
            background-color: #2d2d2d;
        }

        .contact.active {
            background-color: #e3f2fd;
        }

        .contact.active.dark-mode {
            background-color: #1e1e1e;
        }

        /* Estilos para los botones de configuraci√≥n */
        .config-buttons {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .config-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .config-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
            transform: scale(1.1);
        }

        .dark-mode .config-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .back-button {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 15px;
            background-color: #00796b;
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-weight: 500;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 1000;
        }

        .back-button:hover {
            background-color: #00695c;
        }

        .back-button.dark-mode {
            background-color: #2d2d2d;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <!-- Botones de configuraci√≥n -->
    <div class="config-buttons">
        <button id="languageToggle" class="config-btn" title="Cambiar idioma">üá∫üá∏</button>
        <button id="themeToggle" class="config-btn" title="Cambiar tema">üåô</button>
    </div>

    <a href="/home" class="back-button" data-i18n="back">‚Üê Volver</a>

    <div class="chat-container">
        <div class="contacts-list">
            <h2 data-i18n="contacts">Contactos</h2>
            <div th:each="contact : ${contacts}" 
                 class="contact"
                 th:classappend="${contact.id == selectedContactId ? 'active' : ''}"
                 th:onclick="'selectContact(' + ${contact.id} + ')'">
                <div th:text="${contact.nombre}"></div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <h3 th:text="${selectedContact != null ? selectedContact.nombre : 'Selecciona un contacto'}"
                    data-i18n-default="select_contact">
                    Selecciona un contacto
                </h3>
            </div>

            <div class="messages" id="messagesContainer">
                <div th:each="message : ${messages}" 
                     th:class="'message ' + ${message.emisor.id == currentUserId ? 'sent' : 'received'}">
                    <div class="message-content" th:text="${message.mensaje}"></div>
                    <div class="message-time" 
                         th:text="${#temporals.format(message.fechaEnvio, 'dd/MM/yyyy HH:mm')}">
                    </div>
                </div>
            </div>

            <form class="chat-input" id="messageForm">
                <input type="hidden" id="receptorId" name="receptorId" 
                       th:value="${selectedContact != null ? selectedContact.id : ''}">
                <input type="text" id="mensaje" name="mensaje" 
                       data-i18n-placeholder="write_message" placeholder="Escribe un mensaje..." autocomplete="off" required>
                <button type="submit" class="send-button" data-i18n="send">Enviar</button>
            </form>
        </div>
    </div>

    <!-- Script de idiomas embebido -->
    <script>
        const languages = {
            es: {
                "back": "‚Üê Volver",
                "contacts": "Contactos",
                "select_contact": "Selecciona un contacto",
                "write_message": "Escribe un mensaje...",
                "send": "Enviar"
            },
            en: {
                "back": "‚Üê Back",
                "contacts": "Contacts",
                "select_contact": "Select a contact",
                "write_message": "Write a message...",
                "send": "Send"
            }
        };

        // Gestor de internacionalizaci√≥n
        class I18nManager {
            constructor() {
                this.currentLanguage = localStorage.getItem('language') || 'es';
                this.loadLanguage();
            }

            loadLanguage() {
                this.updateTexts();
                this.updateLanguageToggle();
            }

            toggleLanguage() {
                this.currentLanguage = this.currentLanguage === 'es' ? 'en' : 'es';
                localStorage.setItem('language', this.currentLanguage);
                this.updateTexts();
                this.updateLanguageToggle();
            }

            updateTexts() {
                const texts = languages[this.currentLanguage];
                
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (texts[key]) {
                        element.textContent = texts[key];
                    }
                });

                document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    if (texts[key]) {
                        element.placeholder = texts[key];
                    }
                });

                // Actualizar el texto por defecto si no hay contacto seleccionado
                const headerElement = document.querySelector('[data-i18n-default="select_contact"]');
                if (headerElement && headerElement.textContent.trim() === 'Selecciona un contacto') {
                    headerElement.textContent = texts["select_contact"];
                }

                document.title = this.currentLanguage === 'es' ? 'Chat M√©dico' : 'Medical Chat';
            }

            updateLanguageToggle() {
                const languageToggle = document.getElementById('languageToggle');
                if (languageToggle) {
                    languageToggle.textContent = this.currentLanguage === 'es' ? 'üá∫üá∏' : 'üá™üá∏';
                    languageToggle.title = this.currentLanguage === 'es' ? 'English' : 'Espa√±ol';
                }
            }
        }

        // Modo oscuro
        const body = document.body;
        const themeToggle = document.getElementById('themeToggle');

        if (localStorage.getItem('darkMode') === 'enabled') {
            body.classList.add('dark-mode');
            document.querySelector('.chat-container').classList.add('dark-mode');
            document.querySelector('.chat-header').classList.add('dark-mode');
            document.querySelectorAll('.message').forEach(msg => msg.classList.add('dark-mode'));
            document.querySelector('.chat-input input').classList.add('dark-mode');
            document.querySelectorAll('.contact').forEach(contact => contact.classList.add('dark-mode'));
            document.querySelector('.back-button').classList.add('dark-mode');
            themeToggle.textContent = '‚òÄÔ∏è';
        }

        themeToggle.addEventListener('click', () => {
            const isDarkMode = body.classList.toggle('dark-mode');
            document.querySelector('.chat-container').classList.toggle('dark-mode');
            document.querySelector('.chat-header').classList.toggle('dark-mode');
            document.querySelectorAll('.message').forEach(msg => msg.classList.toggle('dark-mode'));
            document.querySelector('.chat-input input').classList.toggle('dark-mode');
            document.querySelectorAll('.contact').forEach(contact => contact.classList.toggle('dark-mode'));
            document.querySelector('.back-button').classList.toggle('dark-mode');
            themeToggle.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
        });

        // Inicializar sistema de idiomas
        const i18n = new I18nManager();
        document.getElementById('languageToggle').addEventListener('click', () => {
            i18n.toggleLanguage();
        });
    </script>

    <!-- Script funcional existente -->
    <script th:inline="javascript">
        const currentUserId = /*[[${currentUserId}]]*/ null;
        
        function selectContact(contactId) {
            if (!contactId) return;
            window.location.href = `/chat?contactId=${contactId}`;
        }
    
        function actualizarMensajes() {
            const receptorId = document.getElementById('receptorId')?.value;
            if (!receptorId) return;
    
            fetch(`/chat/mensajes/${receptorId}`)
                .then(response => response.json())
                .then(mensajes => {
                    const messagesContainer = document.getElementById('messagesContainer');
                    if (messagesContainer && mensajes) {
                        messagesContainer.innerHTML = mensajes.map(msg => `
                            <div class="message ${msg.emisor.id === currentUserId ? 'sent' : 'received'}">
                                <div class="message-content">${msg.mensaje}</div>
                                <div class="message-time">${new Date(msg.fechaEnvio).toLocaleString()}</div>
                            </div>
                        `).join('');
                        
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                })
                .catch(error => console.error('Error al actualizar mensajes:', error));
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            const messageForm = document.getElementById('messageForm');
            if (messageForm) {
                messageForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const receptorId = formData.get('receptorId');
                    const mensaje = formData.get('mensaje');
    
                    if (!receptorId || !mensaje) {
                        alert('Por favor selecciona un contacto y escribe un mensaje');
                        return;
                    }
    
                    fetch('/chat/enviar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(formData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('mensaje').value = '';
                            actualizarMensajes();
                        } else {
                            alert('Error al enviar mensaje: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al enviar mensaje');
                    });
                });
            }
    
            const receptorId = document.getElementById('receptorId')?.value;
            if (receptorId) {
                actualizarMensajes();
                setInterval(actualizarMensajes, 5000);
            }
        });
    </script>
</body>
</html>